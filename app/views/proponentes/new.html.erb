<div class="container mt-5">
  <h1 class="mb-5 text-center display-6">Cadastro de Novo Proponente</h1>

  <%= form_with(model: @proponente, local: true, class: 'needs-validation', novalidate: true) do |form| %>
    <% if @proponente.errors.any? %>
      <div class="alert alert-danger mb-4">
        <h4><%= pluralize(@proponente.errors.count, "erro") %> impediram este proponente de ser salvo:</h4>
        <ul>
          <% @proponente.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="card p-5 shadow-lg border-0 rounded-3">
      <!-- Nome e CPF -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :nome, class: 'form-label fw-bold' %>
          <%= form.text_field :nome, placeholder: 'Digite o nome completo', class: 'form-control', required: true %>
        </div>
        <div class="col-md-6 mb-3">
          <%= form.label :cpf, class: 'form-label fw-bold' %>
          <%= form.text_field :cpf, placeholder: '000.000.000-00', class: 'form-control', required: true %>
        </div>
      </div>

      <!-- Data de Nascimento -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= form.label :data_nascimento, class: 'form-label fw-bold' %>
          <%= form.date_field :data_nascimento, placeholder: 'Data de nascimento', class: 'form-control', required: true %>
        </div>
      </div>

      <!-- Endereço: CEP, Logradouro, Bairro, Número, Cidade e Estado -->
      <div class="row">
        <div class="col-md-3 mb-3">
          <%= form.label :cep, class: 'form-label fw-bold' %>
          <%= form.text_field :cep, placeholder: 'CEP', class: 'form-control', required: true %>
        </div>
        <div class="col-md-5 mb-3">
          <%= form.label :logradouro, class: 'form-label fw-bold' %>
          <%= form.text_field :logradouro, placeholder: 'Rua, avenida, etc.', class: 'form-control', required: true %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :bairro, class: 'form-label fw-bold' %>
          <%= form.text_field :bairro, placeholder: 'Bairro', class: 'form-control', required: true %>
        </div>
      </div>
      <div class="row">
        <div class="col-md-3 mb-3">
          <%= form.label :numero, class: 'form-label fw-bold' %>
          <%= form.text_field :numero, placeholder: 'Número', class: 'form-control', required: true %>
        </div>
        <div class="col-md-5 mb-3">
          <%= form.label :cidade, class: 'form-label fw-bold' %>
          <%= form.text_field :cidade, placeholder: 'Cidade', class: 'form-control', required: true %>
        </div>
        <div class="col-md-4 mb-3">
          <%= form.label :estado, class: 'form-label fw-bold' %>
          <%= form.text_field :estado, placeholder: 'Estado (UF)', class: 'form-control', required: true %>
        </div>
      </div>

      <!-- Telefones: Pessoal, Referência e Salário-->
      <div class="row">
        <%= form.fields_for :telefones do |telefones_form| %>
          <div class="col-md-3 mb-3">
            <%= telefones_form.label :pessoal, 'Telefone Pessoal', class: 'form-label fw-bold' %>
            <%= telefones_form.text_field :pessoal, placeholder: '(XX) XXXX-XXXX', class: 'form-control', required: true %>
          </div>
          <div class="col-md-3 mb-3">
            <%= telefones_form.label :referencia, 'Telefone Referência', class: 'form-label fw-bold' %>
            <%= telefones_form.text_field :referencia, placeholder: '(XX) XXXX-XXXX', class: 'form-control' %>
          </div>
        <% end %>

        <div class="col-md-3 mb-3">
          <%= form.label :salario, class: 'form-label fw-bold' %>
          <%= form.number_field :salario, step: 0.01, placeholder: 'Salário em reais', id: 'salario_input', class: 'form-control', required: true %>
        </div>
      </div>

      <!-- Desconto INSS -->
      <div id="desconto_inss" class="mb-3 alert alert-info d-none"></div>

      <!-- Botões -->
      <div class="d-flex justify-content-end gap-3 mt-4">
        <%= link_to 'Voltar', proponentes_path, class: 'btn btn-outline-secondary btn-lg' %>
        <%= form.submit 'Criar Proponente', class: 'btn btn-primary btn-lg' %>
      </div>
    </div>
  <% end %>
</div>

<script>
document.getElementById('salario_input').addEventListener('change', function() {
  const salario = this.value;
  fetch(`/proponentes/calcular_inss?salario=${salario}`)
    .then(response => response.json())
    .then(data => {
      const descontoElement = document.getElementById('desconto_inss');
      descontoElement.textContent = `Desconto INSS: R$ ${data.desconto.toFixed(2)}`;
      descontoElement.classList.remove('d-none');
    });
});
</script>